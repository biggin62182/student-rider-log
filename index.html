<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Rider Log</title>
  <style>
    :root{ --bg:#0b0c10; --ink:#e8eaf0; --muted:#a0a6b3; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; color:var(--ink); background:var(--bg); line-height:1.45;}
    .wrap{max-width:1200px;margin:24px auto 80px;padding:0 16px;}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    form{padding:20px;display:grid;gap:16px;}
    .grid{display:grid;gap:12px;} @media(min-width:780px){ .cols-2{grid-template-columns:1fr 1fr;} .cols-3{grid-template-columns:repeat(3,1fr);} }
    label{display:block;font-size:14px;margin:0 0 6px;color:var(--muted);}
    input,select,button{font:inherit;color:var(--ink);} input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(15,17,23,.85);outline:none;}
    .toolbar{padding:14px 20px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.15);flex-wrap:wrap;}
    .btn{padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(122,193,255,.15);cursor:pointer;font-weight:700;font-size:13px}
    .btn.secondary{background:rgba(255,255,255,.06)} .btn.danger{background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.25)} .btn.success{background:rgba(56,211,159,.2);border-color:rgba(56,211,159,.35)}
    .btn.help{background:rgba(255, 231, 92, .22); border-color: rgba(255, 231, 92, .35)}

    /* WEEK GRID */
    .weekWrap{position:relative}
    .week-hint{display:none;font-size:12px;color:var(--muted);margin-top:6px}
    .week-grid{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(160px,1fr));}
    .dayCard{padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

    /* Make week grid horizontally scrollable on small screens */
    @media (max-width: 779px){
      .week-grid{
        grid-auto-flow: column;
        grid-auto-columns: minmax(220px, 85%);
        grid-template-columns: unset;
        overflow-x: auto;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }
      .dayCard{ scroll-snap-align: start; }
      .week-hint{ display:block; }
    }

    .submissions{margin-top:22px;}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.02);min-width:1100px;}
    thead th{font-size:12.5px;color:var(--muted);padding:8px 10px;background:rgba(0,0,0,.25);text-align:left;white-space:nowrap;}
    tbody td{padding:8px 10px;border-top:1px solid rgba(255,255,255,.06);font-size:13px;white-space:nowrap;}
    .actions{display:flex;gap:6px;flex-wrap:wrap;}
    .empty{padding:14px;color:var(--muted);font-size:14px;border:1px dashed rgba(255,255,255,.18);border-radius:12px;text-align:center;}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin:8px 0 12px;}
    .dim{color:var(--muted);font-size:13px;}
    .spacer{flex:1 1 auto}
    .hint{font-size:12px;color:var(--muted);}

    /* PRINT (LANDSCAPE) */
    #printArea{ display:none; }
    @media print{
      @page{ size: Letter landscape; margin: .35in; }
      body{ background:#fff; color:#000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .submissions, form, .toolbar{ display:none !important; }
      #printArea{ display:block !important; }

      /* Weekly report card */
      .reportCard{ page-break-inside: avoid; border:1px solid #999; border-radius:10px; padding:10px 12px; margin:6px 0; background:#fff; color:#000; }
      .reportHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:6px; }
      .h1{ font-size:16px; font-weight:800; }
      .meta{ font-size:11px; color:#333; }
      .gridInfo{ display:grid; grid-template-columns:1fr 1fr; gap:6px 14px; margin-bottom:6px; }
      .label{ font-size:11px; color:#555; }
      .value{ font-size:12px; color:#000; font-weight:600; }
      .tableWrap{ overflow:hidden; border:1px solid #999; border-radius:8px; margin-top:4px; }
      .miniTable{ width:100%; border-collapse:collapse; table-layout:fixed; }
      .miniTable th, .miniTable td{ border-bottom:1px solid #bbb; padding:6px 8px; font-size:12px; text-align:left; word-wrap:break-word; overflow-wrap:anywhere; }
      .miniTable thead th{ background:#eef3fb; }
      .miniTable col.col-day{ width:36%; }
      .miniTable col.col-am{ width:32%; }
      .miniTable col.col-pm{ width:32%; }

      /* Monthly Calendar Grid (per student) */
      .monthTitle{ font-size:18px; font-weight:800; margin: 0 0 8px; }
      .studentInfo{ border:1px solid #999; border-radius:10px; padding:8px 12px; margin: 6px 0 10px; }
      .studentInfoTitle{ font-size:14px; font-weight:800; margin:0 0 6px; }
      .studentGrid{ display:grid; grid-template-columns:1fr 1fr; gap:6px 14px; }
      .calendar{ width:100%; border-collapse:separate;border-spacing:0; table-layout:fixed; border:1px solid #999; border-radius:10px; overflow:hidden; }
      .calendar thead th{ background:#eef3fb; border-bottom:1px solid #999; font-size:12px; padding:6px 8px; }
      .calendar td{ border-right:1px solid #ddd; border-bottom:1px solid #ddd; vertical-align:top; padding:6px 6px; height:82px; }
      .calendar tr:last-child td{ border-bottom:none; }
      .calendar td:last-child{ border-right:none; }
      .dayHeader{ display:flex; justify-content:space-between; gap:6px; align-items:center; font-weight:700; font-size:12px; }
      .muted{ color:#666; }
      .ampm{ font-size:11px; margin:2px 0; }
      .ampm span{ font-weight:700; }

      /* Signature block */
      .signatureBlock{ margin-top:10px; display:flex; gap:24px; align-items:flex-end; break-inside: avoid; }
      .sigItem{ display:flex; align-items:flex-end; gap:8px; font-size:12px; color:#333; }
      .sigLine{ border-bottom:1px solid #000; width:280px; height:14px; position:relative; }
      .sigLine.short{ width:160px; }
      .sigText{ position:relative; top:2px; font-family:"Brush Script MT","Segoe Script","Comic Sans MS",cursive; font-size:16px; color:#000; }
      .dateText{ position:relative; top:2px; font-size:13px; color:#000; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <form id="riderForm" novalidate>
        <input type="hidden" id="recordId" />
        <div class="grid cols-3">
          <div><label for="weekOf">Week of</label><input id="weekOf" type="date" /></div>
          <div style="grid-column: span 2;"><label for="studentName">Student name *</label><input id="studentName" required placeholder="e.g., Jordan A. Rivera" /></div>
        </div>

        <div class="grid cols-2">
          <div><label for="street">Street address *</label><input id="street" required placeholder="123 Main St" /></div>
          <div><label for="street2">Apt / Unit</label><input id="street2" placeholder="Apt 4B" /></div>
        </div>

        <div class="grid cols-3">
          <div><label for="city">City *</label><input id="city" required placeholder="Springfield" /></div>
          <div><label for="state">State *</label>
            <select id="state" required>
              <option value="">Select…</option>
              <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option>
              <option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option>
              <option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option>
              <option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option>
              <option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option>
              <option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
              <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option>
              <option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option>
              <option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option>
              <option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
              <option>DC</option><option>PR</option><option>GU</option><option>VI</option><option>AS</option><option>MP</option>
            </select>
          </div>
          <div><label for="zip">ZIP *</label><input id="zip" placeholder="64016 or 64016-1234" /></div>
        </div>

        <div class="grid cols-3">
          <div><label for="homeDistrict">Home Address District *</label><input id="homeDistrict" required /></div>
          <div><label for="schoolName">School Attending</label><input id="schoolName" /></div>
          <div><label for="schoolDistrict">Attending District *</label><input id="schoolDistrict" required /></div>
        </div>

        <fieldset>
          <legend class="dim">Weekly ride log: Rode, NS (no show), Sick, Car Rider, No School</legend>
          <div class="weekWrap">
            <div id="daysContainer" class="week-grid"></div>
            <div class="week-hint">Swipe to see all days →</div>
          </div>
          <template id="optionTemplate">
            <option value="">—</option>
            <option>Rode</option>
            <option>NS (no show)</option>
            <option>Sick</option>
            <option>Car Rider</option>
            <option>No School</option>
          </template>
          <template id="dayTemplate">
            <div class="dayCard">
              <div style="font-size:13px;color:#a0a6b3;font-weight:700;text-transform:uppercase" data-day-label></div>
              <div class="twoCol">
                <div><label>AM</label><select data-am></select></div>
                <div><label>PM</label><select data-pm></select></div>
              </div>
            </div>
          </template>
        </fieldset>

        <div class="toolbar">
          <button type="button" class="btn secondary" id="btnNew">New entry</button>
          <button type="reset" class="btn secondary">Reset</button>
          <button type="submit" class="btn" id="btnSave">Save entry</button>
        </div>
      </form>
    </section>

    <section class="submissions">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0;">
        <h2 style="margin:0;font-size:18px;">Saved entries</h2>
      </div>

      <!-- Compact: Student → Week picker -->
      <div class="controls">
        <div>
          <label for="studentPicker">Student</label>
          <select id="studentPicker"></select>
        </div>
        <div>
          <label for="weekPicker">Saved week</label>
          <select id="weekPicker"></select>
        </div>
        <div class="actions">
          <button id="qpEdit" class="btn secondary" type="button">Edit</button>
          <button id="qpPdf" class="btn" type="button">PDF</button>
          <button id="qpDup" class="btn success" type="button">Duplicate → New Week</button>
        </div>
        <span class="spacer"></span>
        <div class="actions">
          <button id="btnHelp" class="btn help" type="button">Help & Tips</button>
          <button id="btnExport" class="btn secondary" type="button">Export</button>
          <button id="btnImport" class="btn" type="button">Import…</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <!-- Monthly PDF (per student) -->
      <div class="controls">
        <div>
          <label for="monthInput">Monthly calendar (per student)</label>
          <input id="monthInput" type="month" />
        </div>
        <div>
          <label for="driverName">Driver name (for signature)</label>
          <input id="driverName" placeholder="e.g., Taylor M. Johnson" />
        </div>
        <button id="btnMonthlyPdf" class="btn" type="button">Monthly Print to PDF</button>
      </div>

      <details id="toggleAll" style="margin:10px 0;">
        <summary class="dim">Show all saved entries (optional)</summary>
        <div id="allWrap" style="overflow:auto;margin-top:8px;">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Actions</th>
                <th>Week of</th>
                <th>Student</th>
                <th>Address</th>
                <th>Home district</th>
                <th>School</th>
                <th>Attending district</th>
                <th>Mon AM</th><th>Mon PM</th>
                <th>Tue AM</th><th>Tue PM</th>
                <th>Wed AM</th><th>Wed PM</th>
                <th>Thu AM</th><th>Thu PM</th>
                <th>Fri AM</th><th>Fri PM</th>
                <th>Saved</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </details>

      <div id="emptyState" class="empty">No entries yet. Add your first student above.</div>
      <div class="hint">Tip: Data is stored only on this device & browser. Use Export to back up or move it.</div>
    </section>
  </div>

  <div id="printArea" aria-hidden="true"></div>

  <script>
    (function(){
      const KEY = "student_rider_records_v1";
      const PREFS_KEY = "student_rider_prefs_v1";
      const VERSION = 1;

      const form = document.getElementById("riderForm");
      const table = document.getElementById("dataTable");
      const tbody = document.getElementById("tableBody");
      const emptyState = document.getElementById("emptyState");
      const weekOfInput = document.getElementById("weekOf");
      const recordIdInput = document.getElementById("recordId");
      const studentPicker = document.getElementById("studentPicker");
      const weekPicker = document.getElementById("weekPicker");
      const qpEdit = document.getElementById("qpEdit");
      const qpPdf = document.getElementById("qpPdf");
      const qpDup = document.getElementById("qpDup");
      const monthInput = document.getElementById("monthInput");
      const driverNameInput = document.getElementById("driverName");
      const btnMonthlyPdf = document.getElementById("btnMonthlyPdf");
      const btnHelp = document.getElementById("btnHelp");
      const btnExport = document.getElementById("btnExport");
      const btnImport = document.getElementById("btnImport");
      const importFile = document.getElementById("importFile");
      const btnNew = document.getElementById("btnNew");

      const streetInput = document.getElementById("street");
      const street2Input = document.getElementById("street2");
      const cityInput = document.getElementById("city");
      const stateInput = document.getElementById("state");
      const zipInput = document.getElementById("zip");
      const homeDistrictInput = document.getElementById("homeDistrict");
      const schoolNameInput = document.getElementById("schoolName");
      const schoolDistrictInput = document.getElementById("schoolDistrict");

      const days = [
        { key: "mon", label: "Monday" },
        { key: "tue", label: "Tuesday" },
        { key: "wed", label: "Wednesday" },
        { key: "thu", label: "Thursday" },
        { key: "fri", label: "Friday" }
      ];

      // Build day cards
      function buildDayCards(){
        const container = document.getElementById("daysContainer");
        const dayTpl = document.getElementById("dayTemplate");
        const optTpl = document.getElementById("optionTemplate");
        container.innerHTML = "";
        days.forEach(({key,label})=>{
          const node = dayTpl.content.firstElementChild.cloneNode(true);
          node.querySelector("[data-day-label]").textContent = label;
          const amSel = node.querySelector("[data-am]");
          const pmSel = node.querySelector("[data-pm]");
          amSel.id = key+"Am"; amSel.name = key+"Am";
          pmSel.id = key+"Pm"; pmSel.name = key+"Pm";
          amSel.appendChild(optTpl.content.cloneNode(true));
          pmSel.appendChild(optTpl.content.cloneNode(true));
          container.appendChild(node);
        });
      }
      buildDayCards();

      // Prefs (driver name)
      function loadPrefs(){
        try{ return JSON.parse(localStorage.getItem(PREFS_KEY) || "{}"); }catch{ return {}; }
      }
      function savePrefs(p){ localStorage.setItem(PREFS_KEY, JSON.stringify(p||{})); }
      const prefs = loadPrefs();
      if(prefs.driverName) driverNameInput.value = prefs.driverName;
      driverNameInput.addEventListener("input", ()=>{
        savePrefs({ ...(loadPrefs()||{}), driverName: driverNameInput.value.trim() });
      });

      // Dates from "Week of" (Monday start)
      function startOfWeekMonday(date){
        const d = new Date(date); const day = d.getDay(); const diff = (day===0?-6:1-day); d.setDate(d.getDate()+diff); d.setHours(0,0,0,0); return d;
      }
      function toInputDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
      function renderDefaultWeekOf(){ if(!weekOfInput.value){ weekOfInput.value = toInputDate(startOfWeekMonday(new Date())); } }
      renderDefaultWeekOf();

      function getDayDatesFromWeekOf(weekOfStr){
        if(!weekOfStr) return {};
        const mon = startOfWeekMonday(new Date(weekOfStr));
        const fmt = d => toInputDate(d);
        const dates = {};
        ["mon","tue","wed","thu","fri"].forEach((k,i)=>{
          const d = new Date(mon); d.setDate(mon.getDate()+i); dates[k] = fmt(d);
        });
        return dates;
      }
      function formatNice(dstr){
        if(!dstr) return "";
        const d = new Date(dstr);
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      }
      function updateDayLabels(){
        const week = weekOfInput.value;
        const d = getDayDatesFromWeekOf(week);
        days.forEach(({key,label})=>{
          const card = document.getElementById(key+"Am").closest(".dayCard");
          const header = card.querySelector("[data-day-label]");
          header.textContent = `${label} (${formatNice(d[key])})`;
        });
      }
      weekOfInput.addEventListener("change", updateDayLabels);
      updateDayLabels();

      function load(){ try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }catch{ return []; } }
      function save(all){ localStorage.setItem(KEY, JSON.stringify(all)); }
      function genId(){ return (crypto?.randomUUID? crypto.randomUUID(): (Date.now().toString(36)+Math.random().toString(36).slice(2))); }

      function fmtAddress(r){
        const l2 = r.street2 ? (", " + r.street2) : "";
        return `${r.street}${l2}, ${r.city}, ${r.state} ${r.zip}`;
      }

      // Robust AM/PM getter
      function getWeekVal(w, day, ap){
        if(!w) return "";
        const keys = [
          day+ap, day+ap.toUpperCase(), day+ap.toLowerCase(),
          day.charAt(0).toUpperCase()+day.slice(1)+ap, day.toUpperCase()+ap,
          day+"_"+ap, day+"-"+ap
        ];
        for(const k of keys){
          if(Object.prototype.hasOwnProperty.call(w,k)){
            const v = w[k];
            return (v==null? "": String(v).trim());
          }
        }
        return "";
      }

      function normalizeShort(v){
        if(!v) return "";
        return String(v)
          .replace(/NS \(no show\)/gi, "NS")
          .replace(/Car Rider/gi,"Car")
          .replace(/No School/gi,"Closed")
          .trim();
      }

      // New Entry button clears ID and fields
      btnNew?.addEventListener("click", ()=>{
        form.reset();
        recordIdInput.value = "";
        renderDefaultWeekOf();
        updateDayLabels();
        // keep driverName preference
        if(loadPrefs().driverName) document.getElementById("driverName").value = loadPrefs().driverName;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Save / Update with smart "save as new" when student/week changed
      form.addEventListener("submit", (ev)=>{
        ev.preventDefault();
        const week = {
          monAm: document.getElementById("monAm").value,
          monPm: document.getElementById("monPm").value,
          tueAm: document.getElementById("tueAm").value,
          tuePm: document.getElementById("tuePm").value,
          wedAm: document.getElementById("wedAm").value,
          wedPm: document.getElementById("wedPm").value,
          thuAm: document.getElementById("thuAm").value,
          thuPm: document.getElementById("thuPm").value,
          friAm: document.getElementById("friAm").value,
          friPm: document.getElementById("friPm").value
        };
        const draft = {
          id: recordIdInput.value || "",
          weekOf: document.getElementById("weekOf").value,
          studentName: document.getElementById("studentName").value.trim(),
          street: document.getElementById("street").value.trim(),
          street2: document.getElementById("street2").value.trim(),
          city: document.getElementById("city").value.trim(),
          state: document.getElementById("state").value.trim(),
          zip: document.getElementById("zip").value.trim(),
          homeDistrict: document.getElementById("homeDistrict").value.trim(),
          schoolName: document.getElementById("schoolName").value.trim(),
          schoolDistrict: document.getElementById("schoolDistrict").value.trim(),
          week,
          savedAt: new Date().toISOString()
        };

        const all = load();
        const original = all.find(r => r.id === draft.id);
        // If editing but Student or Week changed, treat as NEW entry
        if (original && (original.studentName !== draft.studentName || original.weekOf !== draft.weekOf)) {
          draft.id = "";
        }
        const rec = { ...draft, id: draft.id || genId() };

        const idx = all.findIndex(r=> r.id===rec.id);
        if(idx>=0){ all[idx]=rec; } else { all.unshift(rec); }
        save(all);
        render();
        recordIdInput.value = rec.id;
        alert("Saved. You can keep filling the week, or start a New entry for another student.");
      });

      // Printable (weekly) cards
      const printArea = document.getElementById("printArea");
      function cell(txt){ const td=document.createElement('td'); td.textContent = normalizeShort(txt)||"—"; return td; }
      function strong(label, value){
        const wrap=document.createElement('div'); const l=document.createElement('div'); l.className='label'; l.textContent=label;
        const v=document.createElement('div'); v.className='value'; v.textContent=value||""; wrap.appendChild(l); wrap.appendChild(v); return wrap;
      }
      function makeReportCard(r){
        const sec = document.createElement('section'); sec.className='reportCard';
        const head = document.createElement('div'); head.className='reportHeader';
        const h1 = document.createElement('div'); h1.className='h1'; h1.textContent='Student Rider Log — Weekly Report';
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent='Saved: ' + new Date(r.savedAt||Date.now()).toLocaleString();
        head.appendChild(h1); head.appendChild(meta); sec.appendChild(head);

        const info = document.createElement('div'); info.className='gridInfo';
        info.appendChild(strong('Week of', r.weekOf? new Date(r.weekOf).toLocaleDateString(): ""));
        info.appendChild(strong('Student', r.studentName||""));
        info.appendChild(strong('Home District', r.homeDistrict||""));
        info.appendChild(strong('Attending District', r.schoolDistrict||""));
        info.appendChild(strong('School Attending', r.schoolName||""));
        info.appendChild(strong('Address', fmtAddress(r)));
        sec.appendChild(info);

        const dd = getDayDatesFromWeekOf(r.weekOf);
        const wrap = document.createElement('div'); wrap.className='tableWrap';
        const table = document.createElement('table'); table.className='miniTable';
        const colgrp = document.createElement('colgroup');
        colgrp.innerHTML = '<col class="col-day"><col class="col-am"><col class="col-pm">';
        table.appendChild(colgrp);

        const thead = document.createElement('thead'); const trh=document.createElement('tr');
        ['Day','AM','PM'].forEach(t=>{ const th=document.createElement('th'); th.textContent=t; trh.appendChild(th); }); thead.appendChild(trh); table.appendChild(thead);

        const tb = document.createElement('tbody');
        const w=r.week||{};
        [
          [`Monday (${formatNice(dd.mon)})`, getWeekVal(w,'mon','Am'), getWeekVal(w,'mon','Pm')],
          [`Tuesday (${formatNice(dd.tue)})`, getWeekVal(w,'tue','Am'), getWeekVal(w,'tue','Pm')],
          [`Wednesday (${formatNice(dd.wed)})`, getWeekVal(w,'wed','Am'), getWeekVal(w,'wed','Pm')],
          [`Thursday (${formatNice(dd.thu)})`, getWeekVal(w,'thu','Am'), getWeekVal(w,'thu','Pm')],
          [`Friday (${formatNice(dd.fri)})`, getWeekVal(w,'fri','Am'), getWeekVal(w,'fri','Pm')],
        ].forEach(row=>{ const tr=document.createElement('tr'); tr.appendChild(cell(row[0])); tr.appendChild(cell(row[1])); tr.appendChild(cell(row[2])); tb.appendChild(tr); });
        table.appendChild(tb); wrap.appendChild(table); sec.appendChild(wrap);
        return sec;
      }
      function printRecords(records){
        if(!records || !records.length){ alert("Nothing to print."); return; }
        const printArea = document.getElementById("printArea");
        printArea.innerHTML=""; records.forEach((r,i)=>{ printArea.appendChild(makeReportCard(r)); if(i<records.length-1){ const br=document.createElement('div'); br.style.pageBreakAfter='always'; printArea.appendChild(br); }});
        setTimeout(()=>window.print(), 10);
      }

      // Edit / Duplicate / Delete / PDF buttons in table
      function enterEditMode(r){
        recordIdInput.value = r.id;
        document.getElementById("weekOf").value = r.weekOf || "";
        document.getElementById("studentName").value = r.studentName || "";
        streetInput.value = r.street || "";
        street2Input.value = r.street2 || "";
        cityInput.value = r.city || "";
        stateInput.value = r.state || "";
        zipInput.value = r.zip || "";
        homeDistrictInput.value = r.homeDistrict || "";
        schoolNameInput.value = r.schoolName || "";
        schoolDistrictInput.value = r.schoolDistrict || "";
        const w = r.week || {};
        document.getElementById("monAm").value = getWeekVal(w,'mon','Am');
        document.getElementById("monPm").value = getWeekVal(w,'mon','Pm');
        document.getElementById("tueAm").value = getWeekVal(w,'tue','Am');
        document.getElementById("tuePm").value = getWeekVal(w,'tue','Pm');
        document.getElementById("wedAm").value = getWeekVal(w,'wed','Am');
        document.getElementById("wedPm").value = getWeekVal(w,'wed','Pm');
        document.getElementById("thuAm").value = getWeekVal(w,'thu','Am');
        document.getElementById("thuPm").value = getWeekVal(w,'thu','Pm');
        document.getElementById("friAm").value = getWeekVal(w,'fri','Am');
        document.getElementById("friPm").value = getWeekVal(w,'fri','Pm');
        updateDayLabels();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      function duplicateToNextWeek(r){
        const base = r.weekOf ? new Date(r.weekOf) : new Date();
        const s = new Date(base); s.setDate(s.getDate() - s.getDay()); s.setDate(s.getDate()+7); // next Sunday
        const weekOf = `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-${String(s.getDate()).padStart(2,'0')}`;
        const blankWeek = { monAm:"",monPm:"",tueAm:"",tuePm:"",wedAm:"",wedPm:"",thuAm:"",thuPm:"",friAm:"",friPm:"" };
        const newRec = { ...r, id: genId(), weekOf, week: blankWeek, savedAt: new Date().toISOString() };
        const all = load(); all.unshift(newRec); save(all); render(); enterEditMode(newRec);
      }
      function render(){
        const rows = load();
        const has = rows.length>0;
        emptyState.style.display = has? "none" : "block";
        // Compact pickers
        populateQuickPicker(rows);
        // Build big table (hidden until user opens details)
        tbody.innerHTML="";
        if(has){
          rows.forEach(r=>{
            const tr=document.createElement('tr');
            const tdAct=document.createElement('td');
            const actions=document.createElement('div'); actions.className='actions';
            const bEdit=document.createElement('button'); bEdit.className='btn secondary'; bEdit.textContent='Edit'; bEdit.addEventListener('click',()=>enterEditMode(r));
            const bDup=document.createElement('button'); bDup.className='btn success'; bDup.textContent='Duplicate → New Week'; bDup.addEventListener('click',()=>duplicateToNextWeek(r));
            const bPdf=document.createElement('button'); bPdf.className='btn'; bPdf.textContent='PDF'; bPdf.addEventListener('click',()=>printRecords([r]));
            const bDel=document.createElement('button'); bDel.className='btn danger'; bDel.textContent='Delete'; bDel.addEventListener('click',()=>{
              const ok = confirm(`Confirm delete?\n\nStudent: ${r.studentName||"(no name)"}\nWeek of: ${r.weekOf? new Date(r.weekOf).toLocaleDateString(): ""}`);
              if(!ok) return; const all=load().filter(x=>x.id!==r.id); save(all); render();
            });
            [bEdit,bDup,bPdf,bDel].forEach(b=>actions.appendChild(b)); tdAct.appendChild(actions); tr.appendChild(tdAct);
            const tdWeek=document.createElement('td'); tdWeek.textContent=r.weekOf? new Date(r.weekOf).toLocaleDateString(): ""; tr.appendChild(tdWeek);
            const tdName=document.createElement('td'); tdName.textContent=r.studentName||""; tr.appendChild(tdName);
            const tdAddr=document.createElement('td'); tdAddr.textContent=fmtAddress(r); tr.appendChild(tdAddr);
            const tdHome=document.createElement('td'); tdHome.textContent=r.homeDistrict||""; tr.appendChild(tdHome);
            const tdSchool=document.createElement('td'); tdSchool.textContent=r.schoolName||""; tr.appendChild(tdSchool);
            const tdDist=document.createElement('td'); tdDist.textContent=r.schoolDistrict||""; tr.appendChild(tdDist);
            const w=r.week||{};
            [
              getWeekVal(w,'mon','Am'), getWeekVal(w,'mon','Pm'),
              getWeekVal(w,'tue','Am'), getWeekVal(w,'tue','Pm'),
              getWeekVal(w,'wed','Am'), getWeekVal(w,'wed','Pm'),
              getWeekVal(w,'thu','Am'), getWeekVal(w,'thu','Pm'),
              getWeekVal(w,'fri','Am'), getWeekVal(w,'fri','Pm')
            ].forEach(v=>{ const td=document.createElement('td'); td.textContent=normalizeShort(v); tr.appendChild(td); });
            const tdSaved=document.createElement('td'); tdSaved.textContent=new Date(r.savedAt).toLocaleString(); tr.appendChild(tdSaved);
            tbody.appendChild(tr);
          });
        }
      }

      // Quick Picker (dropdowns for student and their weeks)
      function populateQuickPicker(rows){
        const students = Array.from(new Set(rows.map(r=>r.studentName).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
        studentPicker.innerHTML = "";
        const sOpt = document.createElement("option"); sOpt.value=""; sOpt.textContent="— Select student —"; studentPicker.appendChild(sOpt);
        students.forEach(s=>{ const o=document.createElement("option"); o.value=s; o.textContent=s; studentPicker.appendChild(o); });
        weekPicker.innerHTML = "";
        const wOpt = document.createElement("option"); wOpt.value=""; wOpt.textContent="— Select week —"; weekPicker.appendChild(wOpt);
      }
      function populateWeeksForStudent(student){
        const rows = load().filter(r=> r.studentName === student);
        const weeks = Array.from(new Set(rows.map(r=>r.weekOf).filter(Boolean))).sort((a,b)=> (a>b?-1:1));
        weekPicker.innerHTML = "";
        const wOpt = document.createElement("option"); wOpt.value=""; wOpt.textContent="— Select week —"; weekPicker.appendChild(wOpt);
        weeks.forEach(wk=>{
          const o=document.createElement("option");
          const d = new Date(wk);
          o.value = wk;
          o.textContent = d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
          weekPicker.appendChild(o);
        });
      }
      studentPicker.addEventListener("change", (e)=>{
        const s = e.target.value;
        if(s) populateWeeksForStudent(s);
        else { weekPicker.innerHTML = ""; const wOpt = document.createElement("option"); wOpt.value=""; wOpt.textContent="— Select week —"; weekPicker.appendChild(wOpt); }
      });
      function getSelectedRecord(){
        const s = studentPicker.value; const w = weekPicker.value;
        if(!s || !w) return null;
        const rows = load().filter(r=> r.studentName === s && r.weekOf === w);
        if(!rows.length) return null;
        rows.sort((a,b)=> new Date(b.savedAt) - new Date(a.savedAt));
        return rows[0];
      }
      qpEdit.addEventListener("click", ()=>{ const r=getSelectedRecord(); if(!r) return alert("Pick a student and week."); enterEditMode(r); });
      qpPdf.addEventListener("click", ()=>{ const r=getSelectedRecord(); if(!r) return alert("Pick a student and week."); printRecords([r]); });
      qpDup.addEventListener("click", ()=>{ const r=getSelectedRecord(); if(!r) return alert("Pick a student and week."); duplicateToNextWeek(r); });

      // ---- Monthly Calendar Grid (per student) ----
      function parseMonthStr(monthStr){
        let y, m0;
        if(monthStr && /^\d{4}-\d{2}$/.test(monthStr)){
          y = parseInt(monthStr.slice(0,4),10);
          m0 = parseInt(monthStr.slice(5,7),10) - 1;
        }else{
          const now = new Date(); y = now.getFullYear(); m0 = now.getMonth();
        }
        return { y, m0 };
      }
      function monthRange(y, m0){
        const first = new Date(y, m0, 1);
        const last = new Date(y, m0+1, 0);
        const gridStart = new Date(first); gridStart.setDate(first.getDate() - first.getDay());
        const gridEnd = new Date(last); gridEnd.setDate(last.getDate() + (6 - last.getDay()));
        const days = []; const d = new Date(gridStart);
        while(d <= gridEnd){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
        return { first, last, gridStart, gridEnd, days };
      }
      function toIso(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"); }
      function monthlyDataForStudent(y, m0, student){
        const byDate = new Map(); // "YYYY-MM-DD" -> { am, pm, savedAt }
        const rows = load().filter(r=> r.studentName === student);
        rows.forEach(r=>{
          const dd = getDayDatesFromWeekOf(r.weekOf || "");
          const w = r.week || {};
          const savedAt = r.savedAt || "";
          [["mon"],["tue"],["wed"],["thu"],["fri"]].forEach(([k])=>{
            const iso = dd[k]; if(!iso) return;
            const d = new Date(iso);
            if(d.getFullYear() !== y || d.getMonth() !== m0) return;
            const am = getWeekVal(w, k, "Am");
            const pm = getWeekVal(w, k, "Pm");
            if(!am && !pm) return;
            const existing = byDate.get(iso);
            if(!existing || new Date(savedAt) > new Date(existing.savedAt || 0)){
              byDate.set(iso, { am, pm, savedAt });
            }else{
              if(!existing.am && am) existing.am = am;
              if(!existing.pm && pm) existing.pm = pm;
            }
          });
        });
        return byDate;
      }
      function latestRecordForStudent(student){
        const rows = load().filter(r=> r.studentName === student);
        if(!rows.length) return null;
        rows.sort((a,b)=> new Date(b.savedAt) - new Date(a.savedAt));
        return rows[0];
      }
      function makeMonthlyCalendarForStudent(monthStr, student, driverName){
        const { y, m0 } = parseMonthStr(monthStr);
        const { days: gridDays } = monthRange(y, m0);
        const byDate = monthlyDataForStudent(y, m0, student);
        if(byDate.size === 0){ alert("No entries for that student in that month."); return null; }

        const infoRec = latestRecordForStudent(student) || {};
        const wrap = document.createElement('section'); wrap.className='reportCard';
        const head = document.createElement('div'); head.className='reportHeader';
        const h1 = document.createElement('div'); h1.className='h1 monthTitle'; h1.textContent='Student Rider Log — Monthly Calendar';
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent= new Date(y, m0, 1).toLocaleDateString(undefined, { month: "long", year: "numeric" });
        head.appendChild(h1); head.appendChild(meta); wrap.appendChild(head);

        // Rider info above calendar
        const infoBox = document.createElement('div'); infoBox.className='studentInfo';
        const title = document.createElement('div'); title.className='studentInfoTitle'; title.textContent='Rider Information';
        infoBox.appendChild(title);
        const grid = document.createElement('div'); grid.className='studentGrid';
        function addRow(label, value){ const w=document.createElement('div'); const l=document.createElement('div'); l.className='label'; l.textContent=label; const v=document.createElement('div'); v.className='value'; v.textContent=value||""; w.appendChild(l); w.appendChild(v); grid.appendChild(w); }
        addRow('Student', infoRec.studentName||student||"");
        addRow('Home District', infoRec.homeDistrict||"");
        addRow('Attending District', infoRec.schoolDistrict||"");
        addRow('School Attending', infoRec.schoolName||"");
        addRow('Address', infoRec.street? `${infoRec.street}${infoRec.street2?(", "+infoRec.street2):""}, ${infoRec.city||""}, ${infoRec.state||""} ${infoRec.zip||""}` : "");
        infoBox.appendChild(grid); wrap.appendChild(infoBox);

        // Calendar grid
        const table = document.createElement('table'); table.className='calendar';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].forEach(wd=>{
          const th=document.createElement('th'); th.textContent=wd; trh.appendChild(th);
        });
        thead.appendChild(trh); table.appendChild(thead);
        const tbodyCal = document.createElement('tbody');
        for(let i=0; i<gridDays.length; i+=7){
          const tr = document.createElement('tr');
          for(let j=0; j<7; j++){
            const d = gridDays[i+j];
            const iso = toIso(d);
            const td = document.createElement('td');
            const header = document.createElement('div'); header.className='dayHeader' + (d.getMonth()!==m0?' muted':''); 
            header.innerHTML = `<span>${d.getDate()}</span>`;
            td.appendChild(header);

            const rec = byDate.get(iso);
            if(rec){
              const am = normalizeShort(rec.am) || "—";
              const pm = normalizeShort(rec.pm) || "—";
              const line1 = document.createElement('div'); line1.className='ampm'; line1.innerHTML = `<span>AM:</span> ${am}`;
              const line2 = document.createElement('div'); line2.className='ampm'; line2.innerHTML = `<span>PM:</span> ${pm}`;
              td.appendChild(line1); td.appendChild(line2);
            }
            tr.appendChild(td);
          }
          tbodyCal.appendChild(tr);
        }
        table.appendChild(tbodyCal);
        wrap.appendChild(table);

        // Signature + Date lines (auto-fill)
        const sig = document.createElement('div'); sig.className='signatureBlock';
        const today = new Date().toLocaleDateString();
        sig.innerHTML = `
          <div class="sigItem"><span>Driver Signature:</span><div class="sigLine"><span class="sigText">${driverName ? driverName : ""}</span></div></div>
          <div class="sigItem"><span>Date:</span><div class="sigLine short"><span class="dateText">${today}</span></div></div>
        `;
        wrap.appendChild(sig);
        return wrap;
      }

      btnMonthlyPdf.addEventListener("click", ()=>{
        const monthStr = monthInput.value;
        const student = studentPicker.value;
        const driverName = (driverNameInput.value || "").trim();
        if(!student){ alert("Pick a student for the monthly calendar."); return; }
        if(driverName){ savePrefs({ ...(loadPrefs()||{}), driverName }); }
        const card = makeMonthlyCalendarForStudent(monthStr, student, driverName);
        if(!card) return;
        const printArea = document.getElementById("printArea");
        printArea.innerHTML = "";
        printArea.appendChild(card);
        setTimeout(()=>window.print(), 10);
      });

      // ---------- Export / Import ----------
      function download(filename, text){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 100);
      }
      function exportAll(){
        const data = {
          version: VERSION,
          exportedAt: new Date().toISOString(),
          records: load(),
          prefs: loadPrefs()
        };
        const ts = new Date().toISOString().replace(/[-:]/g,'').slice(0,15);
        download(`student_rider_backup_${ts}.json`, JSON.stringify(data, null, 2));
      }
      function importMerge(json){
        let incoming = [];
        let prefsIn = {};
        try{
          const obj = JSON.parse(json);
          incoming = Array.isArray(obj) ? obj : (obj.records || []);
          prefsIn = obj.prefs || {};
        }catch(e){
          alert("Invalid JSON file."); return;
        }
        const existing = load();
        const byId = new Map(existing.map(r=>[r.id, r]));
        let added = 0, updated = 0;
        for(const rec of incoming){
          if(!rec || !rec.id) continue;
          const old = byId.get(rec.id);
          if(!old){ byId.set(rec.id, rec); added++; }
          else{
            const newer = (new Date(rec.savedAt||0) > new Date(old.savedAt||0)) ? rec : old;
            if(newer === rec) updated++;
            byId.set(rec.id, newer);
          }
        }
        const merged = Array.from(byId.values()).sort((a,b)=> new Date(b.savedAt)-new Date(a.savedAt));
        localStorage.setItem(KEY, JSON.stringify(merged));
        if(Object.keys(prefsIn).length){ savePrefs({ ...(loadPrefs()||{}), ...prefsIn }); }
        render();
        alert(`Import complete. Added ${added}, updated ${updated}.`);
      }
      btnExport.addEventListener("click", exportAll);
      btnImport.addEventListener("click", ()=> importFile.click());
      importFile.addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => importMerge(ev.target.result);
        reader.readAsText(f);
        importFile.value = "";
      });

      // ---------- Help Window ----------
      function openHelp(){
        const w = window.open("", "_blank", "noopener,noreferrer,width=900,height=800");
        if(!w){ alert("Pop-up blocked. Please allow pop-ups for this page to view Help."); return; }
        const css = `
          body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:20px;color:#111;max-width:900px;margin:0 auto;}
          h1{margin:0 0 12px;font-size:22px}
          h2{margin:18px 0 8px;font-size:18px;border-bottom:1px solid #eee;padding-bottom:4px}
          ol,ul{padding-left:20px}
          code, .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#f3f3f3;border-radius:6px;padding:1px 6px}
          .note{color:#444;background:#fff8d8;border:1px solid #f0e2a0;border-radius:8px;padding:8px 10px;margin:8px 0}
          .tip{color:#155724;background:#e6ffed;border:1px solid #b7f5c5;border-radius:8px;padding:8px 10px;margin:8px 0}
          .muted{color:#666}
          @media print{ body{color:#000} .note,.tip{border-color:#aaa} }
        `;
        const html = `<!doctype html><html><head><meta charset="utf-8"><title>Help • Student Rider Log</title><style>${css}</style></head>
        <body>
          <h1>Help & Tips — Student Rider Log</h1>
          <p class="muted">This page covers saving/printing on mobile, exporting/importing data, duplicating weeks, and viewing/printing saved entries.</p>

          <h2>Save as PDF (Android)</h2>
          <ol>
            <li>Open the week or month you want to print and tap <span class="kbd">PDF</span> or <span class="kbd">Monthly Print to PDF</span>.</li>
            <li>In the Android print sheet, choose <strong>Save as PDF</strong> as the printer.</li>
            <li>Set orientation to <strong>Landscape</strong>.</li>
            <li>Tap <strong>Save</strong> and pick a folder.</li>
          </ol>

          <h2>Save as PDF (iPhone/iPad)</h2>
          <ol>
            <li>Open the week or month and tap <span class="kbd">PDF</span> or <span class="kbd">Monthly Print to PDF</span>.</li>
            <li>When the iOS print preview shows, pinch out on the preview to open a full‑page PDF.</li>
            <li>Tap the <strong>Share</strong> icon → choose <strong>Save to Files</strong> or your PDF app.</li>
            <li>Make sure orientation is <strong>Landscape</strong> if asked.</li>
          </ol>

          <h2>Export your data</h2>
          <ol>
            <li>On the main page, click <span class="kbd">Export</span>.</li>
            <li>A file like <code>student_rider_backup_YYYYMMDD.json</code> will download.</li>
            <li>Keep it somewhere safe (Drive, iCloud, etc.).</li>
          </ol>

          <h2>Import your data</h2>
          <ol>
            <li>Click <span class="kbd">Import…</span> and choose your backup <code>.json</code> file.</li>
            <li>Entries are <strong>merged</strong> by ID. Newer versions win if duplicates exist.</li>
            <li>Driver name preference is imported too.</li>
          </ol>

          <h2>Duplicate a week for a new week</h2>
          <ol>
            <li>Use the <strong>Student</strong> and <strong>Saved week</strong> pickers to select an entry.</li>
            <li>Click <span class="kbd">Duplicate → New Week</span>.</li>
            <li>A new blank week is created starting the next calendar week. Edit and save.</li>
          </ol>

          <h2>View saved weekly entries</h2>
          <ul>
            <li>Use the compact pickers: choose a <strong>Student</strong> → then choose a <strong>Saved week</strong>.</li>
            <li>Click <span class="kbd">Edit</span> to load it back into the form.</li>
            <li>Or open <strong>Show all saved entries</strong> to see the full list with actions.</li>
          </ul>

          <h2>Print a saved week</h2>
          <ol>
            <li>Select a student and week with the pickers.</li>
            <li>Click <span class="kbd">PDF</span> to open a printable weekly report.</li>
            <li>Choose <strong>Landscape</strong> and save/print.</li>
          </ol>

          <div class="note"><strong>Where data is stored?</strong> Everything is saved locally in your browser. To move devices or switch browsers, use <em>Export</em> on the old device and <em>Import…</em> on the new one.</div>
          <div class="tip"><strong>Signature:</strong> Enter the driver name next to the Monthly print button. It prints as an electronic signature and the date auto‑fills.</div>
        </body></html>`;
        w.document.open();
        w.document.write(html);
        w.document.close();
      }
      btnHelp.addEventListener("click", openHelp);

      // initial render
      render();
    })();
  </script>
  <div id="printArea" aria-hidden="true"></div>
</body>
</html>
